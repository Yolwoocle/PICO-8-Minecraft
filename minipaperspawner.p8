pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
-- paper dungeon
-- by @yolwoocle

particles = {}
actors = {}

gndh = 120

spwnr_mob = {
	spr=16,
	dy=0,
	x=64,
	y=106,
	g=0.2,
	bounce=1.8,
	flipx=false,
}

function spwnr_mob.update(s)
	s.dy += s.g
	s.y += s.dy
	if s.y+8>gndh then
		s.y=gndh-8
		s.dy=-s.bounce
		s.flipx=not s.flipx
	end
end

function spwnr_mob.draw(s)
	spr(s.spr,s.x,s.y,1,1, s.flipx)	
end
	
-- 웃 = shift+j
웃 = {
	x=64,
	y=64,
	dx=0,
	dy=0,
	
	jumpf=0,
	maxjumpf=5,
	canjump=true,
	grounded=false,
	justlanded=false,
	walled=false,
	wallside=-1,
	
	life=10,
	
	hx=0,
	hy=0,
	hw=8,
	hh=16,
	
	dir=1,
	g=0.22,
	jumpspd=5,
	spd=1,
	friction=1,

	char=0, --0=steve, 1=alex
	spr=0,
	sx=-8,
	sy=0,
	squash=1,
	dsqsh=0.1,
	
	anim={25,26},
	animh={1,0},
	animf=0,
	animspd=0.2,
	flipx=false,
}
웃.dx = 웃.spd

function 웃:reset()

end

function 웃.update(p)
	-- walls
	p.walled = false
	if p.x<8 or 119<p.x+p.hw and
	not p.walled then
		p.walled = true
		p.wallside = sign(p.dx)
	end
	
	if p.walled then
		p.dx = 0
		p.dy = 1
		if p.grounded or jump() then
			p.walled = false
			p.dx = p.spd
			p.dir *= -1
			if jump() then
				p.dy = -p.jumpspd * p.y/80
			end
		end
	end
	
	-- jump
	if jump() and p.grounded then
		p.dy = -p.jumpspd
	end
	
	-- apply gravity
	p.dy += p.g
		
	-- apply speed
	p.dy *= p.friction
	
	p.x += p.dx * p.dir
	p.y += p.dy
	
	-- ground collision
	local lastgnd = p.grounded
	p.grounded = false
	p.justlanded = false
	if p.y+p.hh > gndh then 
		p.y = 127-p.hh
		p.grounded = true
		if(not lastgnd)p.justlanded=true
	end
	
	-- squash
	local s = p.squash
	local epsilon = 0.1
	if s < 1-epsilon then
		p.squash += s/7
	elseif s > 1+epsilon then
		p.squash -= s/7
	else
		p.squash = 1
	end
	
	-- sprite flipping
	p.flipx = p.dir < 0
	
	-- particles
	if rnd(1)<0.2 and p.grounded then
		add(particles, make_ptc(
			{p.x,p.y+8},
			{-p.dir,0},
			{rnd(6),-rnd(6),rnd(6)},
			13,5
		))
	end
	
	-- animations
	if p.grounded then
		p.animf += p.animspd
		p.animf %= #p.anim
		p.spr = p.anim[flr(p.animf)+1]
		p.sy = -p.animh[flr(p.animf)+1]
	else
		p.spr = 64
		p.sy = 0
	end
end

function 웃.draw(p)
	spr(p.spr, p.x-p.sx, p.y-p.sy)
	local flp = p.flipx and -1 or 1
end
-->8
--init
function _init()
	reset_pal()
	gen_wall()
	add(actors, 웃)
end
-->8
--update
function _update60()
	for a in all(actors)do
		a:update()
	end
	for i in all(particles)do
		update_ptc(i)
		if i.life > i.maxlife then
			del(particles,i)
		end
	end
	
	spwnr_mob:update()
end

-->8
--draw
function _draw()
	cls()
	spwnr_mob:draw()
	map()	
	for i in all(actors)do
		i:draw()
	end
	for i in all(particles)do
		draw_ptc(i)
	end
	
	color(7)
	print("",9,9)
	?"squash "..웃.squash
	?"sq "..flr(웃.squash+0.05*10)/10
end
-->8
-- functions
function sprcoor(index)
--converts sprite index to  
--spritesheet coordinates
 return {x=index%16*8,y=index\16*8}
end

function sprs(n,x,y,w,h,dw,dh)
--is like spr, but w/ stretch
--doesn't support flipping
 s=sprcoor(n)
 w=(w or 1)*8
 h=(h or 1)*8
 dw=dw or w
 dh=dh or h
 dw*=8*(w/8)
 dh*=8*(h/8)
 x-=(dw-w)/2
 y-=(dh-h)/2
 
 sspr(s.x,s.y,w,h,x,y,dw,dh)
end

function sign(n)
	if(n==0)return 0
	if(n>0) return 1
	return -1
end

function reset_pal()
 pal(10,12+128,1)
	poke(0x5f2e,1)
end

function gen_wall()
	local c = {1,2,3,4}
	for i=0,15 do
		mset(i,0,rnd(c))
		mset(i,15,rnd(c))
		mset(0,i,rnd(c))
		mset(15,i,rnd(c))
	end
end

function boxcoll(a1,a2,b1,b2)
	return (
	a1.x < b2.x and
	b2.x > b1.x and
	a1.y < b2.y and 
	a2.y > b1.y)
end

function jump()
 return btnp(⬆️) or btnp(🅾️)
end
-->8
--particles

function make_ptc(pos,spd,s,c,c2)
	return {
		x=pos[1],
		y=pos[2],
		dx=spd[1],
		dy=spd[2],
		sx=s[1],
		sy=s[2],
		sz=s[3],
		ds=0.9,
		g=0,
		col=c,
		scol=c2,
		
		life=0,
		maxlife=rnd(30)+30,
	}
end

function update_ptc(p)
	p.dx *= 0.9
	p.dy *= 0.9
	p.x += p.dx
	p.y += p.dy
	p.sx *= p.ds
	p.sy *= p.ds
	p.sz *= p.ds
	
	p.life += 1 
end

function draw_ptc(p)
	rectfill(p.x, p.y,
	p.x+p.sx, p.y+p.sy, p.col)
	rectfill(p.x+p.sx, p.y,
	p.x+p.sx+p.sz, p.y+p.sy, p.scol)
end
__gfx__
0000000066ddd5d56ddd555dd5bb55566ddd5b5d555500001aaaacccacaaa11111aa1a1108808800000000000044f40004444440000000000000000000000000
00888800566d5ddddd5d56655b33d566dd5d5b3555550000a01001100110010a101001018e888880011011000777777004222240000000000000000000000000
0800088055556ddd5dd556665336d5635dd5b33655550000a01000a00a00010a1010010188888880111111100744f4700eeeee90000000000000000000000000
080080805dd56d6d655566dd353d55b36555333d55550000acca11c11c11ccaaa1a11a1a28888820111111100070070004222240000000000000000000000000
080800806d6d56d5d6d56ddd3d55b35dd6b533dd55550000aaaa00a00a00aaaa11100111028882000111110007e78e7004444440000000000000000000000000
0880008066dd5655dddd55dd6d6b3335bb3355dd55550000aaa100a00a001a1a1010010100282000001110007e7888e702222220000000000000000000000000
008888005665ddddddd566556d536dddb335bb5555550000a0a00accaaa00a0aa1aa111a00020000000100007e8888e702666600000000000000000000000000
00000000d555566d55566ddddd55ddd5555b333d55550000a1c11accaaa11c1a10aa110100000000000000000777777002222220000000000000000000000000
333333303333333055666dd055666dd033bbbbb033bbbbb0a0a00a8aa8a00a0a1021120122244444222444444449999944499999000000000000000000000000
333bbb30333bbb3055666660556666603311b1103311b110a0aa1aaccaa01a0a111aa1112224fff42224fff444499ff944499ff9000000000000000000000000
33bbbbb033bbbbb055556550555565503311311033113110a0a000aaaa000a0a1001100122e7afa722e7afa744e73f3744e73f37000000000000000000000000
3311b1103311b1105566d6405566d64033b111b033b111b0a1c1111cc1111c1a11a11a1122effeff22effeff44efffff44efffff000000000000000000000000
33b333b033b333b0556555645565556433b1b1b033b1b1b0a0a000a00a000a0a101001012eef444f2eef444f444ffeff444ffeff000000000000000000000000
0aa3bc3b0aa3bc3b05dd6dd605dd6dd603bbbb0003bbbb00a1a001a00a100a1a111001110accccc00accccc003999bb003999bb0000000000000000000000000
0acccc000acccc000566660405666604333bbbb0333bbbb0a0a000a00a000a0a101001010efcccf0efacccef0efbbbf0ef3bbbef000000000000000000000000
01a01a001a0001a005605640560005603b3d3d303b3d3d301aaaacccacaaaaa111aa1a11001a1a0001a001a00024240002400240000000000000000000000000
00222244444444000044499999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00222244444444000044499999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0022224ffffff4000044499ff9999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002222f7affa7f0000444973ff379000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0022e2f7affa7f000044ef73ff379000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0022e2fff44fff00004eeffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0022eeff4ff4ff00004eefffeefff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002eeeff4444ff000044effffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000aacccccffffccccc000000000aaccccffffcccc0000000000aaccccffffcccc0000000000aaccccffffcccc0000000000aaccccffffcccc0000000099990
0000aaccccccffcccccc000000000aacccccffccccc000000000aacccaccffccaccc0000000000aaccccffcccc000000000000aaccccffcccc00000000000990
0000eeffffcccccccfff000000000eefffccccccfff00000000eefffaacccccceefff000000000eefffcccccff0000000000000eefffccccf000000000000099
0000eeffffcccccccfff00000000eefffaccccccefff000000eefff0aacccccc0eeeee00000000eefffcccccff00000000000000eefffccc0000000000000000
0000eeffffaaaaaaafff00000000eefff1aaaaaaefff0000000fff0011aaa1aa00eee0000000000eefffaaaaf0000000000000001eefffaa0000000000000000
0000000111aaaaaaa00000000000000011aaaaaa00000000000000000116661000000000000000011aaa11aaa0000000000000011aeee1666000000000000000
00000005556666666000000000000000055666600000000000000000001566600000000000000005566655666000000000000055666005555500000000000000
00000005556666666000000000000000055666600000000000000000006555000000000000000055666005566600000000000056660000555000000000000000
00000aaccccffffcccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000eefffaccffccafff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000eefffaacccccceefff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000fff0aacccccc0eee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000011aaaaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000011aaa11666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000055666005555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000056660000555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0105000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0105000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0105000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0105000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0105000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0105000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0105000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0105000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0105000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0105000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0105000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0105000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0105000000000006070800000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0105000000000016171800000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
